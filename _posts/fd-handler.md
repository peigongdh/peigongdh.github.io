## 文件描述符和句柄

> https://www.jianshu.com/p/0ff9ff1d108e

查看系统中文件句柄的数量：
```
$ cat /proc/sys/fs/file-nr
203136  0   19593935
```

通过lsof计算文件描述符数量
```
$lsof | wc -l
253
```

/proc/sys/fs/file-nr这里所展示的数据
第一列->已分配文件句柄的数目，
第二列->已使用文件句柄的数目，
第三列->文件句柄的最大数目，
通过下面这个文件也可以看到文件句柄的最大数目
```
$ cat /proc/sys/fs/file-max 
19593935
```

那问题来了：

- 什么是文件描述符，什么是句柄？
- 为什么文件描述符和句柄的大小要一样？
- 为什么文件描述符和句柄的大小要不一样？
- 上面的问题不一定都对，但是可以带着思考往下看

### 句柄

Windows下的概念。句柄是Windows下各种对象的标识符，比如文件、资源、菜单、光标等等。文件句柄和文件描述符类似，它也是一个非负整数，也用于定位文件数据在内存中的位置。
由于Linux下所有的东西都被看成文件，所以Linux下的文件描述符其实就相当于Windows下的句柄。文件句柄只是Windows下众多句柄中的一种类型而已

### 文件描述符

本质上是一个索引号（非负整数），系统用户层可以根据它找到系统内核层的文件数据。这是一个POSIX标准下的概念，常见于Linux系统。内核（kernel）利用文件描述符来访问文件。打开现存文件或新建文件时，内核会返回一个文件描述符。读写文件也需要文件描述符来指定待读写的文件。

### 两者比较

- 一个描述符上可以监控很多的事件，如果监控的是read，然而write事件到来的时候也会将该描述符唤醒
- lsof在用户空间，主要还是从文件描述符的角度来看文件句柄

简单来说，每个进程都有一个打开的文件表（fdtable)。表中的每一项是struct file类型，包含了打开文件的一些属性比如偏移量，读写访问模式等，这是真正意义上的文件句柄。
每个文件描述符都与一个文件所对应的，不同的文件描述符也可能会指向同一个文件，相同的文件描述符也可能会指向不同的文件。这个主要是因为同一个文件可以被不同的进程打开，也可以被同一个进程的多次打开。系统为每一个进程维护了一个文件描述符表，所以在不同的进程中会看到相同的fd。那么要理解具体的内部结构，需要理解下面这三个数据结构：
- 进程级的文件描述符表
- 系统级的打开文件描述符表
- 文件系统i-node表

进程级别的文件描述符表每一条都只是记录了单个文件描述符的信息，主要包含下面几个：
- 控制文件描述符操作的一组标志
- 对打开文件句柄的引用
内核对所有打开的文件都有一个系统级的文件描述符表，各条目称为打开文件句柄（open file handle）一个打开文件句柄存储了一个与一个打开文件相关的所有信息
- 当前文件偏移量（调用read()和write()时更新，或使用lseek()直接修改）
- 打开文件时的标识（open()的flags参数）
- 文件访问模式（读写）
- 与信号驱动相关的设置
- 对该文件i-node对象的引用
- 文件类型（常规文件、socket等）和访问权限
- 一个指针，指向该文件所持有的锁列表
- 文件的各种属性，时间戳啥的，巴拉巴拉

进程文件描述符 -> 系统级文件描述符 -> i-node表
图标略（见引用文章）

在进程A中，文件描述符1和30都指向了系统文件描述符表中的21句柄，这可能是通过dup() dup2() fcnt()或者对同一个文件调用了多次open()导致的
进程A的文件描述符2和进程B的文件描述符2都指向了系统文件描述符的30句柄，这可能是fork()的作用，出现了父子进程
进程A的文件描述符0和进程B的文件描述符3分别指向了不同的句柄，但是最后这两个句柄都指向了i-node表中的66，也就是指向了同一个文件。这是因为进程A和B各自同一个文件发起了open()的操作

### 总结

- 由于进程级的文件描述符表的存在，不同的进程中会出现相同的文件描述符，而相同的文件描述符会指向不同句柄
- 两个不同的文件描述符，如果指向同一个句柄，就会共享同一个文件偏移量，因此，如果其中一个文件描述符修改了偏移量（调用了read、write、lseek），另一个描述符也会感受到变化
- 文件描述符标志为进程和文件描述符私有，这一标志的修改不会影响同一进程或不同进程的其他文件描述符
- 句柄其实是指针的指针。操作系统分为用户态和内核态，用户必然会使用内核的数据，但是用户进程又不能直接获取内核数据结构，所以才出现了指针的指针——句柄，用户态通过句柄调用系统服务，进入内核之后，内核根据句柄找到真正的数据结构

回顾问题
- 什么是文件描述符，什么是句柄？——这个问题已经得到了解答
- 为什么文件描述符和句柄的大小要一样？——刚开始我将文件描述符（fd）和句柄理解成一个概念，以为这两个是一个东西的不同说法。文件描述符主要还是用户态的东西，而句柄主要是内核态的东西，从上面的图就可以理解出来
- 为什么文件描述符和句柄的大小要不一样？——多个文件描述符可以指向同一个句柄，每个进程都会拥有一个文件描述符表。而lsof命令会漏掉很多数据：共享内存等。lsof在用户空间，主要还是从文件描述符的角度来看文件句柄。